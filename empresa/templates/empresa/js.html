{% load filtros %}
<script>
  {% comment %} var ctx = document.getElementById('graficoPedidos').getContext('2d');
  fetch('/api/pedidos/')  // Substitua pelo seu endpoint
  .then(response => response.json())  // Converte JSON para objeto JS
  .then(data => {
      // Extrai as datas (labels) e as quantidades (valores) dos pedidos
      const labels = data.map(item => item.data);  // Data de entrega
      const valores = data.map(item => item.quantidade);  // Quantidade de pedidos

  var graficoPedidos = new Chart(ctx, {
      type: 'line',  // Tipo de gráfico: linha
      data: {
          labels: {{ datas|safe }},  // Datas formatadas
          datasets: [{
              label: 'Pedidos por dia',
              data: {{ pedidos_lista|safe }},  // Quantidade de pedidos por dia
              borderColor: 'blue',
              backgroundColor: 'rgb(149, 229, 112)',
              borderWidth: 1,
              yAxisID: 'y1'
          },{
              label: 'Comparativo mês passado',
              data: {{ pedidos_lista|safe }},  // Quantidade de pedidos por dia
              borderColor: 'blue',
              backgroundColor: 'rgb(228, 109, 109)',
              borderWidth: 1,
              yAxisID: 'y1'
          }, {
              label: 'Faturamento por dia',
              data: {{ valor_lista|safe }},  // Quantidade de faturamento por dia
              borderColor: 'green',
              backgroundColor: 'rgb(133, 139, 217)',
              borderWidth: 1,
              yAxisID: 'y2',
              tooltip: {
                  callbacks: {
                      label: function(tooltipItem) {
                          var valor = tooltipItem.raw;
                          return 'R$ ' + valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                      }
                  }
              }
          }]
      },
      options: {
          responsive: true,  // O gráfico será responsivo
          maintainAspectRatio: false,  // Permite ajustar a proporção
          plugins: {
              legend: {
                  labels: {
                      color: 'black'  // Cor do texto da legenda
                  }
              }
          },
          scales: {
              x: {
                  ticks: {
                      color: 'black'  // Cor dos rótulos do eixo X
                  }
              },
              y1: {
                  min: 0,
                  ticks: {
                      color: 'blue',
                      stepSize: 1
                  },
                  position: 'left'  // Coloca o primeiro eixo à esquerda
              },
              y2: {
                  min: 0,
                  ticks: {
                      color: 'green',
                      stepSize: 1
                  },
                  position: 'right'  // Coloca o segundo eixo à direita
              }
          }
      },
        // Aumenta a resolução, dependendo da tela (Retina)
  }); {% endcomment %}

  let chartInstance = null;  // Variável para armazenar a instância do gráfico

  fetch('/profile/pedidos/api/')
    .then(response => response.json())
    .then(data => {
  
      var init = document.getElementsByName('data_init')[0];
      var end = document.getElementsByName('data_end')[0];
  
      // Função para filtrar dados baseado nas datas selecionadas
      function filtrarDados() {
        const dataInicio = new Date(init.value);  // Pega o valor da data de início
        const dataFim = new Date(end.value);     // Pega o valor da data de fim
  
        // Ajusta a data final para incluir o último dia
        dataFim.setDate(dataFim.getDate() + 1);
  
        // Filtra os dados dentro do intervalo de datas
        const dadosFiltrados = data.filter(item => {
            const dataPedido = new Date(item.data);  
            return dataPedido >= dataInicio && dataPedido <= dataFim;
        });
  
        // Se houver dados filtrados, mapeia para labels e valores
        const labels = dadosFiltrados.map(item => {
            const dataPedido = new Date(item.data);  
            return dataPedido.toLocaleDateString('pt-BR');  // Formata a data para 'dd/mm/yyyy'
        });
  
        const valores = dadosFiltrados.map(item => item.quantidade);
  
        // Calcula o valor máximo para o eixo Y, com um valor de segurança de +10
        const maxY = valores.length > 0 ? Math.max(...valores) + 10 : 10;
  
        // Se já existe um gráfico, destrói-o
        if (chartInstance) {
          chartInstance.destroy();
        }
  
        // Cria o gráfico novamente
        const ctx = document.getElementById('graficoPedidos').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',  // Tipo de gráfico (linha)
            data: {
                labels: labels,
                datasets: [
                {
                    label: 'Quantidade de Pedidos',
                    data: valores,
                    borderColor: 'blue',
                    backgroundColor: 'rgb(194, 237, 141)',
                    borderWidth: 1,
                    yAxisID: 'y'
                }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                devicePixelRatio: window.devicePixelRatio || 4,  // Melhora a renderização em telas de alta resolução
                scales: {
                    x: {
                        ticks: {
                            color: 'black'  // Cor dos rótulos do eixo X
                        }
                    },
                    y: {
                        min: 0,  // Valor mínimo do eixo Y
                        max: maxY,  // Valor máximo do eixo Y
                        ticks: {
                            color: 'blue',
                            stepSize: 1  // Passo entre os ticks
                        },
                        position: 'left'  // Posição do eixo Y à esquerda
                    },
                }
            }
        });
      }
  
      // Adiciona os event listeners
      init.addEventListener('change', filtrarDados);
      end.addEventListener('change', filtrarDados);
  
    })
    .catch(error => console.error('Erro ao carregar JSON:', error));
  
</script>
