{% load filtros %}
<script>
  {% comment %} var ctx = document.getElementById('graficoPedidos').getContext('2d');
  fetch('/api/pedidos/')  // Substitua pelo seu endpoint
  .then(response => response.json())  // Converte JSON para objeto JS
  .then(data => {
      // Extrai as datas (labels) e as quantidades (valores) dos pedidos
      const labels = data.map(item => item.data);  // Data de entrega
      const valores = data.map(item => item.quantidade);  // Quantidade de pedidos

  var graficoPedidos = new Chart(ctx, {
      type: 'line',  // Tipo de gráfico: linha
      data: {
          labels: {{ datas|safe }},  // Datas formatadas
          datasets: [{
              label: 'Pedidos por dia',
              data: {{ pedidos_lista|safe }},  // Quantidade de pedidos por dia
              borderColor: 'blue',
              backgroundColor: 'rgb(149, 229, 112)',
              borderWidth: 1,
              yAxisID: 'y1'
          },{
              label: 'Comparativo mês passado',
              data: {{ pedidos_lista|safe }},  // Quantidade de pedidos por dia
              borderColor: 'blue',
              backgroundColor: 'rgb(228, 109, 109)',
              borderWidth: 1,
              yAxisID: 'y1'
          }, {
              label: 'Faturamento por dia',
              data: {{ valor_lista|safe }},  // Quantidade de faturamento por dia
              borderColor: 'green',
              backgroundColor: 'rgb(133, 139, 217)',
              borderWidth: 1,
              yAxisID: 'y2',
              tooltip: {
                  callbacks: {
                      label: function(tooltipItem) {
                          var valor = tooltipItem.raw;
                          return 'R$ ' + valor.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                      }
                  }
              }
          }]
      },
      options: {
          responsive: true,  // O gráfico será responsivo
          maintainAspectRatio: false,  // Permite ajustar a proporção
          plugins: {
              legend: {
                  labels: {
                      color: 'black'  // Cor do texto da legenda
                  }
              }
          },
          scales: {
              x: {
                  ticks: {
                      color: 'black'  // Cor dos rótulos do eixo X
                  }
              },
              y1: {
                  min: 0,
                  ticks: {
                      color: 'blue',
                      stepSize: 1
                  },
                  position: 'left'  // Coloca o primeiro eixo à esquerda
              },
              y2: {
                  min: 0,
                  ticks: {
                      color: 'green',
                      stepSize: 1
                  },
                  position: 'right'  // Coloca o segundo eixo à direita
              }
          }
      },
        // Aumenta a resolução, dependendo da tela (Retina)
  }); {% endcomment %}

  fetch('/profile/pedidos/api/')
  .then(response => response.json())
  .then(data => {
      const dataInicio = new Date('{{ filter.data_init }}');
      const dataFim = new Date('{{ filter.data_end }}');
      dataFim.setDate(dataFim.getDate() + 1);  // Soma 1 dia à data final para incluir o último dia

      // Filtra os dados dentro do intervalo de datas
      const dadosFiltrados = data.filter(item => {
          const dataPedido = new Date(item.data);  
          return dataPedido >= dataInicio && dataPedido <= dataFim;
      });

      // Se houver dados filtrados, mapeia para labels e valores
      const labels = dadosFiltrados.map(item => {
          const dataPedido = new Date(item.data);  
          return dataPedido.toLocaleDateString('pt-BR');  // Formata a data para 'dd/mm/yyyy'
      });  

      const valores = dadosFiltrados.map(item => item.quantidade);

      // Calcula o valor máximo para o eixo Y, com um valor de segurança de +10
      const maxY = valores.length > 0 ? Math.max(...valores) + 10 : 10;

      // Cria o gráfico
      const ctx = document.getElementById('graficoPedidos').getContext('2d');
      new Chart(ctx, {
          type: 'line',  // Tipo de gráfico (linha)
          data: {
              labels: labels,
              datasets: [
              {
                  label: 'Quantidade de Pedidos',
                  data: valores,
                  borderColor: 'blue',
                  backgroundColor: 'rgb(194, 237, 141)',
                  borderWidth: 1,
                  yAxisID: 'y'
              }
              ]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              devicePixelRatio: window.devicePixelRatio || 4,  // Melhora a renderização em telas de alta resolução
              scales: {
                  x: {
                      ticks: {
                          color: 'black'  // Cor dos rótulos do eixo X
                      }
                  },
                  y: {
                      min: 0,  // Valor mínimo do eixo Y
                      max: maxY,  // Valor máximo do eixo Y
                      ticks: {
                          color: 'blue',
                          stepSize: 1  // Passo entre os ticks
                      },
                      position: 'left'  // Posição do eixo Y à esquerda
                  },
              }
          }
      });
  })
  .catch(error => console.error('Erro ao carregar JSON:', error));

</script>
